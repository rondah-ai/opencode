#!/usr/bin/env node

/**
 * PR Comment Generator
 *
 * Generates formatted PR comments with QA test results
 */

const fs = require('fs');
const path = require('path');

// Parse arguments
const args = process.argv.slice(2);
const resultsFile = getArg('--results') || './qa-results/summary.json';
const previewUrl = getArg('--preview-url') || 'https://preview.example.com';
const prNumber = getArg('--pr-number') || 'unknown';

function main() {
  try {
    // Load test results
    if (!fs.existsSync(resultsFile)) {
      console.log(generateErrorComment('Test results file not found'));
      return;
    }

    const results = JSON.parse(fs.readFileSync(resultsFile, 'utf8'));

    // Generate comment
    const comment = generateComment(results, previewUrl, prNumber);
    console.log(comment);

  } catch (error) {
    console.log(generateErrorComment(error.message));
  }
}

function generateComment(results, previewUrl, prNumber) {
  const { summary, flows, suite, startTime } = results;
  const passRate = summary.total > 0 ? ((summary.passed / summary.total) * 100).toFixed(1) : 0;
  const status = summary.failed === 0 ? 'âœ… PASSED' : 'âŒ FAILED';
  const statusEmoji = summary.failed === 0 ? 'ğŸ‰' : 'âš ï¸';

  return `## ğŸ¤– QA Agent Report

${statusEmoji} **Status:** ${status}

### ğŸ“Š Test Summary

| Metric | Value |
|--------|-------|
| **Suite** | \`${suite}\` |
| **Total Tests** | ${summary.total} |
| **âœ… Passed** | ${summary.passed} |
| **âŒ Failed** | ${summary.failed} |
| **â­ï¸ Skipped** | ${summary.skipped} |
| **Pass Rate** | ${passRate}% |
| **â±ï¸ Duration** | ${(summary.duration / 1000).toFixed(2)}s |

### ğŸ”— Preview URL
${previewUrl}

### ğŸ“‹ Flow Results

${generateFlowTable(flows)}

${summary.failed > 0 ? `
### âŒ Failed Flows

${flows.filter(f => f.status === 'failed').map(f => `
#### \`${f.flowPath}\`
- **Error:** ${f.error || 'Unknown error'}
- **Duration:** ${f.duration}ms
`).join('\n')}
` : ''}

### ğŸ“¸ Artifacts

- [View Full HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
- [Download Screenshots](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

---

<details>
<summary>â„¹ï¸ About QA Agent</summary>

This automated QA test was run using the QA Agent system.

**Test Suite:** \`${suite}\`
**Executed:** ${startTime}
**PR:** #${prNumber}

The QA Agent validates:
- âœ… Flow execution
- âœ… UI interactions
- âœ… Form submissions
- âœ… Navigation
- âœ… Visual regression (if enabled)
- âœ… Accessibility (if enabled)

</details>

---

*ğŸ¤– Generated by QA Agent â€¢ [Re-run tests](https://github.com/${{ github.repository }}/actions/workflows/qa-agent-pr.yml)*
`;
}

function generateFlowTable(flows) {
  if (!flows || flows.length === 0) {
    return '_No flows executed_';
  }

  const rows = flows.map(flow => {
    const statusIcon = flow.status === 'passed' ? 'âœ…' :
      flow.status === 'failed' ? 'âŒ' : 'â­ï¸';
    const duration = `${flow.duration}ms`;

    return `| ${statusIcon} | \`${flow.flowPath}\` | ${duration} |`;
  });

  return `| Status | Flow | Duration |
|--------|------|----------|
${rows.join('\n')}`;
}

function generateErrorComment(errorMessage) {
  return `## ğŸ¤– QA Agent Report

âš ï¸ **Status:** ERROR

### âŒ Test Execution Failed

An error occurred while running the QA tests:

\`\`\`
${errorMessage}
\`\`\`

Please check the [GitHub Actions logs](https://github.com/${{ github.repository }}/actions) for more details.

---

*ğŸ¤– Generated by QA Agent*
`;
}

function getArg(name) {
  const args = process.argv.slice(2);
  const index = args.indexOf(name);
  return index !== -1 && args[index + 1] ? args[index + 1] : null;
}

// Run
main();
